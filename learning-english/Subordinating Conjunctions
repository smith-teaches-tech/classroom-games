<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Quest: Mall Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            margin: 0;
            background: #000;
            font-family: 'Press Start 2P', cursive;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        #gameContainer {
            position: relative;
            background: #222;
            padding: 20px;
            border: 4px solid #444;
        }
        
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            border: 2px solid #666;
        }
        
        #ui {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
        }
        
        #textBox {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: #000;
            border: 4px solid #fff;
            padding: 20px;
            font-size: 12px;
            line-height: 1.8;
            display: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }
        
        #questionModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 4px solid #fff;
            padding: 20px;
            max-width: 500px;
            display: none;
            z-index: 100;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
        }
        
        .questionText {
            color: #0ff;
            margin-bottom: 20px;
            font-size: 12px;
            line-height: 1.8;
        }
        
        .answerButton {
            display: block;
            width: 100%;
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 10px;
            margin: 10px 0;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .answerButton:hover:not(:disabled) {
            background: #fff;
            color: #000;
        }
        
        .answerButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .feedback {
            margin-top: 15px;
            padding: 10px;
            font-size: 10px;
            line-height: 1.8;
            display: none;
        }
        
        .correct {
            color: #0f0;
            border: 2px solid #0f0;
        }
        
        .incorrect {
            color: #f00;
            border: 2px solid #f00;
        }
        
        #instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            font-size: 10px;
            border: 2px solid #666;
            max-width: 200px;
        }
        
        #winMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 4px solid #ff0;
            color: #ff0;
            padding: 30px;
            text-align: center;
            display: none;
            z-index: 200;
            font-size: 14px;
            line-height: 2;
        }
        
        .pixelChar {
            position: absolute;
            width: 32px;
            height: 48px;
            transition: none;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="480"></canvas>
        <div id="ui">
            <div>SCORE: <span id="score">0</span></div>
            <div>CONJUNCTIONS: <span id="masteredCount">0</span>/7</div>
        </div>
    </div>
    
    <div id="instructions">
        GRAMMAR QUEST<br><br>
        ↑↓←→ Move<br>
        SPACE Talk<br><br>
        Find people<br>
        Answer correctly!
    </div>
    
    <div id="textBox"></div>
    
    <div id="questionModal">
        <div class="questionText"></div>
        <div id="answers"></div>
        <div class="feedback"></div>
    </div>
    
    <div id="winMessage">
        ★ QUEST COMPLETE! ★<br><br>
        You mastered all conjunctions!<br><br>
        FINAL SCORE: <span id="finalScore"></span><br><br>
        Press F5 to play again
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        // Game state
        let score = 0;
        let answeredNPCs = [];
        let masteredConjunctions = new Set();
        let currentNPC = null;
        let showingText = false;
        
        // Player state
        const player = {
            x: 400,
            y: 240,
            width: 32,
            height: 48,
            speed: 4,
            facing: 'down',
            moving: false,
            frame: 0
        };
        
        // Input state
        const keys = {};
        
        // Room boundaries
        const room = {
            left: 80,
            right: 720,
            top: 100,
            bottom: 400
        };
        
        // NPCs with positions and dialog
        const npcs = [
            {
                id: 1,
                name: "TIRED STUDENT",
                x: 200,
                y: 200,
                color: '#4682B4',
                idleText: "Yaaawn... So tired...",
                question: "Why do you still look tired?",
                answers: [
                    { text: "I'm tired although I slept for 10 hours.", correct: true, conjunction: "although" },
                    { text: "I'm tired until I slept for 10 hours.", correct: false, feedback: "'Until' shows time limit. You can't be tired UNTIL sleeping!" },
                    { text: "I'm tired whenever I wake up late.", correct: false, feedback: "The question asks why you're STILL tired after good sleep." }
                ]
            },
            {
                id: 2,
                name: "MALL COP",
                x: 600,
                y: 150,
                color: '#2F4F4F',
                idleText: "No running in the mall!",
                question: "Why are you running in the mall?",
                answers: [
                    { text: "I'm running even though it's not allowed.", correct: true, conjunction: "even though" },
                    { text: "I'm running until it's not allowed.", correct: false, feedback: "'Until' means you'd stop when not allowed. It's already not allowed!" },
                    { text: "I'm running if I'm late.", correct: false, feedback: "The guard asks why you're running NOW, not in general." }
                ]
            },
            {
                id: 3,
                name: "CAFE OWNER",
                x: 150,
                y: 350,
                color: '#8B4513',
                idleText: "Fresh coffee! Get your coffee!",
                question: "Why don't you want coffee?",
                answers: [
                    { text: "I don't want coffee since I love it.", correct: false, feedback: "Loving coffee is a reason TO want it!" },
                    { text: "I don't want coffee while I'm thirsty.", correct: false, feedback: "Being thirsty means you SHOULD want drinks!" },
                    { text: "I don't want coffee even though I'm sleepy.", correct: true, conjunction: "even though" }
                ]
            },
            {
                id: 4,
                name: "ANGRY MOM",
                x: 450,
                y: 300,
                color: '#8B008B',
                idleText: "Where's my kid? Have you seen him?",
                question: "When can you use your phone?",
                answers: [
                    { text: "I can't use it until I finish homework.", correct: true, conjunction: "until" },
                    { text: "I can't use it although I finish homework.", correct: false, feedback: "If you finished homework, you SHOULD be able to use it!" },
                    { text: "I can't use it while I finish homework.", correct: false, feedback: "The question asks WHEN you CAN use it." }
                ]
            },
            {
                id: 5,
                name: "JANITOR",
                x: 300,
                y: 280,
                color: '#008080',
                idleText: "This floor won't clean itself...",
                question: "Why can't I clean here now?",
                answers: [
                    { text: "You can't clean while people are shopping.", correct: true, conjunction: "while" },
                    { text: "You can't clean until people are shopping.", correct: false, feedback: "That would mean you clean WHEN people shop!" },
                    { text: "You can't clean although people are shopping.", correct: false, feedback: "The shoppers ARE the reason!" }
                ]
            },
            {
                id: 6,
                name: "BOOKWORM",
                x: 650,
                y: 350,
                color: '#4B0082',
                idleText: "These prices are ridiculous!",
                question: "Why are books so expensive?",
                answers: [
                    { text: "Books are expensive since paper costs more now.", correct: true, conjunction: "since" },
                    { text: "Books are expensive while paper costs more now.", correct: false, feedback: "'While' shows time, not reason. We need WHY!" },
                    { text: "Books are expensive until paper costs more now.", correct: false, feedback: "'Until' doesn't make sense here!" }
                ]
            },
            {
                id: 7,
                name: "PHONE REPAIR GUY",
                x: 500,
                y: 180,
                color: '#B22222',
                idleText: "I fix phones. Don't drop them!",
                question: "When does your phone break?",
                answers: [
                    { text: "It breaks since I drop it.", correct: false, feedback: "'Since' explains why, but the question asks WHEN!" },
                    { text: "It breaks whenever I drop it.", correct: true, conjunction: "whenever" },
                    { text: "It breaks even though I drop it.", correct: false, feedback: "That suggests dropping protects it!" }
                ]
            },
            {
                id: 8,
                name: "GAMER KID",
                x: 350,
                y: 150,
                color: '#FF4500',
                idleText: "The new game comes out soon!",
                question: "When will the new game arrive?",
                answers: [
                    { text: "It won't arrive since next week.", correct: false, feedback: "'Since' means 'because'. Time needs 'until'!" },
                    { text: "It won't arrive if next week.", correct: false, feedback: "'If' is for conditions. This doesn't make sense!" },
                    { text: "It won't arrive until next week.", correct: true, conjunction: "until" }
                ]
            },
            {
                id: 9,
                name: "GYM BRO",
                x: 250,
                y: 320,
                color: '#228B22',
                idleText: "Do you even lift?",
                question: "Why don't you exercise?",
                answers: [
                    { text: "I don't exercise if I'm busy.", correct: true, conjunction: "if" },
                    { text: "I don't exercise while I'm free.", correct: false, feedback: "You don't exercise when you have time? Illogical!" },
                    { text: "I don't exercise until I'm busy.", correct: false, feedback: "You'd START exercising when busy? Backwards!" }
                ]
            }
        ];
        
        // Initialize
        function init() {
            // Keyboard input
            window.addEventListener('keydown', (e) => {
                keys[e.key] = true;
                
                if (e.key === ' ' && !showingText && !document.getElementById('questionModal').style.display) {
                    checkNPCInteraction();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });
            
            // Start game loop
            gameLoop();
        }
        
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        function update() {
            if (showingText || document.getElementById('questionModal').style.display === 'block') {
                player.moving = false;
                return;
            }
            
            // Player movement
            let dx = 0;
            let dy = 0;
            player.moving = false;
            
            if (keys['ArrowUp']) {
                dy = -player.speed;
                player.facing = 'up';
                player.moving = true;
            } else if (keys['ArrowDown']) {
                dy = player.speed;
                player.facing = 'down';
                player.moving = true;
            } else if (keys['ArrowLeft']) {
                dx = -player.speed;
                player.facing = 'left';
                player.moving = true;
            } else if (keys['ArrowRight']) {
                dx = player.speed;
                player.facing = 'right';
                player.moving = true;
            }
            
            // Check boundaries
            const newX = player.x + dx;
            const newY = player.y + dy;
            
            if (newX > room.left && newX < room.right - player.width) {
                player.x = newX;
            }
            if (newY > room.top && newY < room.bottom - player.height) {
                player.y = newY;
            }
            
            // Update animation frame
            if (player.moving) {
                player.frame = (player.frame + 0.2) % 4;
            } else {
                player.frame = 0;
            }
        }
        
        function render() {
            // Clear canvas
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw room
            drawRoom();
            
            // Draw NPCs
            npcs.forEach(npc => drawNPC(npc));
            
            // Draw player
            drawPlayer();
            
            // Draw interaction prompt
            const nearNPC = getNearbyNPC();
            if (nearNPC && !answeredNPCs.includes(nearNPC.id)) {
                ctx.fillStyle = '#fff';
                ctx.font = '10px "Press Start 2P"';
                ctx.fillText('PRESS SPACE TO TALK', player.x - 80, player.y - 10);
            }
        }
        
        function drawRoom() {
            // Floor pattern
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(room.left, room.top, room.right - room.left, room.bottom - room.top);
            
            // Tile pattern
            ctx.strokeStyle = '#555';
            for (let x = room.left; x < room.right; x += 40) {
                for (let y = room.top; y < room.bottom; y += 40) {
                    ctx.strokeRect(x, y, 40, 40);
                }
            }
            
            // Walls
            ctx.fillStyle = '#666';
            ctx.fillRect(0, 0, canvas.width, room.top); // Top wall
            ctx.fillRect(0, room.bottom, canvas.width, canvas.height - room.bottom); // Bottom wall
            ctx.fillRect(0, 0, room.left, canvas.height); // Left wall
            ctx.fillRect(room.right, 0, canvas.width - room.right, canvas.height); // Right wall
            
            // Wall decorations
            ctx.fillStyle = '#888';
            for (let x = 100; x < 700; x += 150) {
                ctx.fillRect(x, 20, 80, 60);
                ctx.fillStyle = '#222';
                ctx.fillRect(x + 10, 30, 60, 40);
                ctx.fillStyle = '#888';
            }
        }
        
        function drawNPC(npc) {
            const isAnswered = answeredNPCs.includes(npc.id);
            
            // Shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(npc.x + 4, npc.y + 44, 24, 8);
            
            // Body
            ctx.fillStyle = isAnswered ? '#444' : npc.color;
            ctx.fillRect(npc.x + 4, npc.y + 16, 24, 24);
            
            // Head
            ctx.fillStyle = isAnswered ? '#666' : '#FDBCB4';
            ctx.fillRect(npc.x + 8, npc.y + 4, 16, 16);
            
            // Hair
            ctx.fillStyle = isAnswered ? '#333' : '#000';
            ctx.fillRect(npc.x + 8, npc.y + 4, 16, 8);
            
            // Eyes
            if (!isAnswered) {
                ctx.fillStyle = '#000';
                ctx.fillRect(npc.x + 12, npc.y + 10, 2, 2);
                ctx.fillRect(npc.x + 18, npc.y + 10, 2, 2);
            }
            
            // Name
            ctx.fillStyle = isAnswered ? '#666' : '#fff';
            ctx.font = '8px "Press Start 2P"';
            ctx.fillText(npc.name, npc.x - 20, npc.y - 5);
        }
        
        function drawPlayer() {
            // Shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(player.x + 4, player.y + 44, 24, 8);
            
            // Body
            ctx.fillStyle = '#4169E1';
            ctx.fillRect(player.x + 4, player.y + 16, 24, 24);
            
            // Head
            ctx.fillStyle = '#FDBCB4';
            ctx.fillRect(player.x + 8, player.y + 4, 16, 16);
            
            // Hair
            ctx.fillStyle = '#654321';
            ctx.fillRect(player.x + 8, player.y + 4, 16, 8);
            
            // Eyes
            ctx.fillStyle = '#000';
            let eyeOffset = 0;
            if (player.facing === 'left') eyeOffset = -2;
            if (player.facing === 'right') eyeOffset = 2;
            ctx.fillRect(player.x + 12 + eyeOffset, player.y + 10, 2, 2);
            ctx.fillRect(player.x + 18 + eyeOffset, player.y + 10, 2, 2);
            
            // Walking animation (simple leg movement)
            if (player.moving) {
                const legOffset = Math.sin(player.frame * 2) * 2;
                ctx.fillStyle = '#333';
                ctx.fillRect(player.x + 8 + legOffset, player.y + 40, 4, 8);
                ctx.fillRect(player.x + 20 - legOffset, player.y + 40, 4, 8);
            }
        }
        
        function getNearbyNPC() {
            for (const npc of npcs) {
                const distance = Math.sqrt(
                    Math.pow(player.x - npc.x, 2) + 
                    Math.pow(player.y - npc.y, 2)
                );
                if (distance < 60) {
                    return npc;
                }
            }
            return null;
        }
        
        function checkNPCInteraction() {
            const npc = getNearbyNPC();
            if (npc && !answeredNPCs.includes(npc.id)) {
                showTextBox(npc.idleText, () => {
                    showQuestion(npc);
                });
            }
        }
        
        function showTextBox(text, callback) {
            const textBox = document.getElementById('textBox');
            textBox.textContent = text;
            textBox.style.display = 'block';
            showingText = true;
            
            setTimeout(() => {
                textBox.style.display = 'none';
                showingText = false;
                if (callback) callback();
            }, 2000);
        }
        
        function showQuestion(npc) {
            currentNPC = npc;
            const modal = document.getElementById('questionModal');
            const questionText = modal.querySelector('.questionText');
            const answersDiv = document.getElementById('answers');
            const feedback = modal.querySelector('.feedback');
            
            questionText.textContent = `${npc.name}: "${npc.question}"`;
            answersDiv.innerHTML = '';
            feedback.style.display = 'none';
            
            // Shuffle answers
            const shuffled = [...npc.answers].sort(() => Math.random() - 0.5);
            
            shuffled.forEach((answer, index) => {
                const button = document.createElement('button');
                button.className = 'answerButton';
                button.textContent = `${index + 1}. ${answer.text}`;
                button.onclick = () => checkAnswer(answer, npc);
                answersDiv.appendChild(button);
            });
            
            modal.style.display = 'block';
        }
        
        function checkAnswer(answer, npc) {
            const feedback = document.querySelector('.feedback');
            const buttons = document.querySelectorAll('.answerButton');
            
            buttons.forEach(btn => btn.disabled = true);
            
            if (answer.correct) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'CORRECT! +10 POINTS';
                score += 10;
                answeredNPCs.push(npc.id);
                masteredConjunctions.add(answer.conjunction);
                
                setTimeout(() => {
                    document.getElementById('questionModal').style.display = 'none';
                    updateUI();
                    checkWin();
                }, 1500);
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = `WRONG! ${answer.feedback} -5 POINTS`;
                score = Math.max(0, score - 5);
                
                setTimeout(() => {
                    document.getElementById('questionModal').style.display = 'none';
                    updateUI();
                }, 3000);
            }
            
            feedback.style.display = 'block';
        }
        
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('masteredCount').textContent = masteredConjunctions.size;
        }
        
        function checkWin() {
            const uniqueConjunctions = new Set();
            npcs.forEach(npc => {
                npc.answers.forEach(answer => {
                    if (answer.correct) {
                        uniqueConjunctions.add(answer.conjunction);
                    }
                });
            });
            
            if (masteredConjunctions.size >= uniqueConjunctions.size) {
                document.getElementById('finalScore').textContent = score;
                document.getElementById('winMessage').style.display = 'block';
            }
        }
        
        // Start game
        init();
    </script>
</body>
</html>
